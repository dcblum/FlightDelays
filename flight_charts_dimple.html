<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>

  <style></style>

  <script type="text/javascript">

    function draw(flight_data) {

      // Set margin, width, and height
      "use strict";
      var margin = 75,
          width = 1400 - margin,
          height = 600 - margin;

      // Append h2 element and add title text
      d3.select('body')
        .append('h2')
        .text('Flight Data');

      // Function for summing variables of flight data
      function agg_flights(leaves) {
        var total_arr_flights = d3.sum(leaves, function(d){
          return d['arr_flights'];
        });
        var total_arr_del15 = d3.sum(leaves, function(d){
          return d['arr_del15'];
        });
        var total_carrier_ct = d3.sum(leaves, function(d){
          return d['carrier_ct'];
        });
        var total_weather_ct = d3.sum(leaves, function(d){
          return d[' weather_ct'];
        });
        var total_nas_ct = d3.sum(leaves, function(d){
          return d['nas_ct'];
        });
        var total_security_ct = d3.sum(leaves, function(d){
          return d['security_ct'];
        });
        var total_late_aircraft_ct = d3.sum(leaves, function(d){
          return d['late_aircraft_ct'];
        });
        var total_arr_cancelled = d3.sum(leaves, function(d){
          return d['arr_cancelled'];
        });
        var total_arr_diverted = d3.sum(leaves, function(d){
          return d['arr_diverted'];
        });
        return {
          'On Time' : 100 * (total_arr_flights - total_arr_del15 -
            total_arr_cancelled - total_arr_diverted) / total_arr_flights,
          'Aircraft Late Arrival' : 100 * total_late_aircraft_ct /
            total_arr_flights,
          'Carrier Delay' : 100 * total_carrier_ct / total_arr_flights,
          'Weather Delay' : 100 * total_weather_ct / total_arr_flights,
          'National Aviation System Delay' : 100 * total_nas_ct /
            total_arr_flights,
          'Security Delay' : 100 * total_security_ct / total_arr_flights,
          'Cancelled / Diverted' : 100 * (total_arr_cancelled +
            total_arr_diverted) / total_arr_flights,
        };
      }


      // Aggregate flight data by carrier_name
      var nested = d3.nest()
                     .key(function(d) {
                        return d['carrier_name'];
                     })
                     .rollup(agg_flights)
                     .entries(flight_data);


      // Sort by alphabetically
      nested.sort(function(a,b){
        var a_key = a.key.toLowerCase(), b_key = b.key.toLowerCase();
        if (a_key < b_key) return -1;
        if (a_key > b_key) return 1;
        return 0;
      });

      // Generate list of airlines to place on X-axis
      var airlines = [];
      for(var i = 0; i < 28; i ++) {
        airlines.push(nested[i].key);
        };

      console.log(nested)

      var svg = dimple.newSvg("#chartContainer", 590,400);

      var myChart = new dimple.chart(svg, nested);
      myChart.setBounds(65, 30, 505, 305)
      var x = myChart.addCategoryAxis("x", "Carrier Name");
      x.addOrderRule("Date");
      myChart.addPctAxis("y", "Percent");
      myChart.addSeries("Channel", dimple.plot.bar);
      myChart.addLegend(60, 10, 510, 20, "right");
      myChart.draw();

      console.log(nested)
    }

  </script>

</head>

<body>
  <div id = 'chartContainer'>
    <script type="text/javascript">

      d3.csv("data/flight_2003_2017.csv", draw);

    </script>
  </div>

</body>
